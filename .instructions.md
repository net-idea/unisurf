# UniSurf Project Instructions

## ğŸ“‹ Project Overview

**UniSurf** is a modern Symfony 7.3 web application with a professional tech stack:

- **Backend**: Symfony 7.3 (PHP 8.3+)
- **Frontend**: Webpack Encore, Bootstrap 5, Stimulus, TypeScript
- **Database**: MariaDB, MySQL, SQLite, or PostgreSQL (configurable)
- **Build Tools**: Yarn, Webpack, Docker, Docker Compose
- **Code Quality**: PHPStan, PHP-CS-Fixer, Stylelint, Prettier, PHPUnit
- **CI/CD**: GitHub Actions (PHP & Node workflows)

## ğŸ›‘ Coding Guidelines & Constraints (Zero Hallucination)

To ensure code accuracy and consistency ("Zero Hallucination" policy):

### Backend (PHP/Symfony)

1.  **Strict Typing**: ALways start PHP files with `declare(strict_types=1);`. Use typed properties and return types.
2.  **Attributes Only**: Use PHP 8 Attributes for Doctrine (`#[ORM\Entity]`), Routing (`#[Route]`), and Validation. **DO NOT** use PHP annotations (`/** @Route ... */`).
3.  **Dependency Injection**: Use Constructor Injection. Avoid fetching services from the container directly (`$container->get()`).
4.  **Repository Pattern**: Put database queries in Repository classes. Keep Controllers thin.
5.  **DTOs**: Use specific Data Transfer Objects for complex forms or API inputs, rather than passing raw arrays or Entities directly if not appropriate.
6.  **No Magic Strings**: Use `::class` constants (e.g., `UserRepository::class`) instead of strings.

### Frontend (Stimulus/Bootstrap)

1.  **Stimulus.js First**: For JavaScript behavior, ALWAYS create a Stimulus controller in `assets/controllers/`. **DO NOT** use jQuery or inline vanilla JS event listeners (`document.querySelector...`) in global scripts.
2.  **Bootstrap 5**: Use Bootstrap 5 utility classes (e.g., `p-3`, `d-flex`, `text-center`) for layout and spacing. Write custom SCSS only when Bootstrap utilities are insufficient.
3.  **TypeScript**: Use TypeScript (`.ts`) for all new frontend logic. Ensure strong typing for interfaces.

### General

1.  **Verify Existence**: Do not assume a file or class exists (e.g., a specific Service or Utility) unless you see it in the file list or have read it.
2.  **Environment Vars**: NEVER hardcode secrets. Use `$_ENV` or `$this->getParameter()` to access configuration.

## ğŸš€ Quick Start

### Prerequisites

- **PHP 8.3+** (8.4 supported)
- **Composer** (v2)
- **Node.js 20+** and **Yarn**
- **Docker & Docker Compose** (for database containers)
- **Git**

### Fastest Setup (Automated)

```bash
./develop.sh
```

Choose one of:

1. **Local dev mode**: Uses host PHP/Yarn + Docker MariaDB container + local Symfony server
2. **Docker Compose mode**: Full containerized stack (PHP-FPM, Nginx, Node Watcher, MariaDB, Mailpit)

### Manual Setup (Local Mode)

```bash
# 1. Install dependencies
composer install
yarn install

# 2. Set up database (SQLite default)
php bin/console doctrine:database:create
php bin/console doctrine:migrations:migrate

# 3. Clear cache
php bin/console cache:clear

# 4. Start development server (in separate terminal)
yarn watch          # Terminal 1: Webpack Encore watcher
symfony server:start --no-tls --port=8000  # Terminal 2: Web server

# 5. Open browser
# http://localhost:8000
```

### Docker Compose Setup (Full Stack)

```bash
docker compose \
  -f docker-compose.yaml \
  -f docker-compose.dev.yaml \
  -f docker-compose.mariadb.yml \
  -f docker-compose.mariadb.dev.yml \
  up -d --build
```

**Access points:**

- App: `http://localhost:8080` (or `${APP_PORT}`)
- Mailpit: `http://localhost:1025` (or `${MAILER_WEB_PORT}`)
- MariaDB: `localhost:3306` (or `${DB_PORT}`)

## ğŸ“ Project Structure

```
unisurf.de/
â”œâ”€â”€ assets/                      # Frontend assets (TypeScript, SCSS)
â”‚   â”œâ”€â”€ app.ts                   # Webpack entry point
â”‚   â”œâ”€â”€ bootstrap.ts             # Stimulus controller bootstrap
â”‚   â”œâ”€â”€ controllers/             # Stimulus controllers
â”‚   â”œâ”€â”€ scripts/                 # UI behavior (TypeScript)
â”‚   â””â”€â”€ styles/                  # Stylesheets (SCSS)
â”‚
â”œâ”€â”€ config/                      # Symfony configuration
â”‚   â”œâ”€â”€ packages/                # Service configurations
â”‚   â”œâ”€â”€ routes/                  # Routing configuration
â”‚   â””â”€â”€ bundles.php              # Enabled bundles
â”‚
â”œâ”€â”€ public/                      # Web root
â”‚   â”œâ”€â”€ index.php                # Front controller
â”‚   â”œâ”€â”€ build/                   # Compiled assets (generated)
â”‚   â””â”€â”€ bundles/
â”‚
â”œâ”€â”€ src/                         # Application source code
â”‚   â”œâ”€â”€ Command/                 # Console commands
â”‚   â”œâ”€â”€ Controller/              # Route controllers
â”‚   â”œâ”€â”€ Entity/                  # Doctrine entities
â”‚   â”œâ”€â”€ Form/                    # Symfony forms
â”‚   â”œâ”€â”€ Repository/              # Doctrine repositories
â”‚   â”œâ”€â”€ Service/                 # Business logic services
â”‚   â””â”€â”€ Kernel.php               # Symfony Kernel
â”‚
â”œâ”€â”€ templates/                   # Twig templates
â”‚   â”œâ”€â”€ base.html.twig           # Base layout with theme support
â”‚   â”œâ”€â”€ _partials/               # Reusable components
â”‚   â”œâ”€â”€ home/                    # Homepage templates
â”‚   â””â”€â”€ contact/                 # Contact form templates
â”‚
â”œâ”€â”€ migrations/                  # Doctrine migrations
â”œâ”€â”€ tests/                       # PHPUnit tests
â”œâ”€â”€ vendor/                      # Composer dependencies (generated)
â”œâ”€â”€ var/                         # Cache & logs (generated)
â”‚   â”œâ”€â”€ cache/
â”‚   â””â”€â”€ log/
â”‚
â”œâ”€â”€ docker/                      # Custom Docker configurations
â”œâ”€â”€ docs/                        # Documentation
â”‚   â”œâ”€â”€ docker.md                # Docker troubleshooting
â”‚   â”œâ”€â”€ symfony.md               # Symfony commands reference
â”‚   â””â”€â”€ database.md              # Database troubleshooting
â”‚
â”œâ”€â”€ .github/workflows/           # GitHub Actions CI/CD
â”‚   â”œâ”€â”€ php.yml                  # PHP quality checks & tests
â”‚   â””â”€â”€ node.yml                 # Node/CSS/TypeScript checks
â”‚
â”œâ”€â”€ Dockerfile                   # Production Docker image
â”œâ”€â”€ docker-compose.yaml          # Production compose
â”œâ”€â”€ docker-compose.dev.yaml      # Dev overrides
â”œâ”€â”€ docker-compose.mariadb.yml   # MariaDB service
â”œâ”€â”€ docker-compose.mariadb.dev.yml # MariaDB dev overrides
â”‚
â”œâ”€â”€ composer.json                # PHP dependencies
â”œâ”€â”€ composer.lock                # Locked PHP versions
â”œâ”€â”€ package.json                 # Node dependencies
â”œâ”€â”€ yarn.lock                    # Locked Node versions
â”œâ”€â”€ webpack.config.js            # Webpack/Encore config
â”œâ”€â”€ tsconfig.json                # TypeScript config
â”œâ”€â”€ phpstan.dist.neon            # Static analysis config
â”œâ”€â”€ phpunit.dist.xml             # Test runner config
â”œâ”€â”€ .php-cs-fixer.dist.php       # Code formatting config
â”‚
â”œâ”€â”€ develop.sh                   # Local dev helper
â”œâ”€â”€ deploy.sh                    # Production deploy helper
â”œâ”€â”€ pipeline.sh                  # CI/CD pipeline runner
â”œâ”€â”€ lint.sh                      # Run all linters
â”œâ”€â”€ phpunit.sh                   # Run tests
â”œâ”€â”€ php-cs-fixer.sh              # Run PHP formatter
â”‚
â””â”€â”€ readme.md                    # Full documentation
```

## ğŸ”§ Environment Configuration

All configuration is via **environment variables**. Create `.env.local` for local overrides:

### Essential Variables

```env
# App
APP_ENV=dev                  # dev, test, or prod
APP_SECRET=<random-string>   # Generate: php bin/console regenerate-app-secret
DEFAULT_URI=http://localhost # Base URL for CLI contexts

# Database (choose one backend)
# SQLite (default)
DATABASE_URL="sqlite:///%kernel.project_dir%/var/data_%kernel.environment%.db"

# MariaDB/MySQL
# DATABASE_URL="mysql://user:pass@127.0.0.1:3306/unisurf?serverVersion=11.4.3-MariaDB&charset=utf8mb4"

# PostgreSQL
# DATABASE_URL="postgresql://user:pass@127.0.0.1:5432/unisurf?serverVersion=16&charset=utf8"

# Messenger
MESSENGER_TRANSPORT_DSN=doctrine://default?auto_setup=0  # or sync:// for dev

# Lock store (for cron/async)
LOCK_DSN=flock                                           # or redis://, semaphore

# Mail (compose into MAILER_DSN)
MAIL_SCHEME=smtp
MAIL_HOST=localhost
MAIL_PORT=1025
# MAIL_ENCRYPTION=tls
# MAIL_USER=your-user
# MAIL_PASSWORD=your-password
```

### Database URL Format by Backend

| Backend    | URL Pattern                                                               |
| ---------- | ------------------------------------------------------------------------- |
| SQLite     | `sqlite:///%kernel.project_dir%/var/data_%kernel.environment%.db`         |
| MariaDB    | `mysql://user:pass@host:3306/db?serverVersion=11.4.3-MariaDB&charset=...` |
| MySQL      | `mysql://user:pass@host:3306/db?serverVersion=8.0&charset=utf8mb4`        |
| PostgreSQL | `postgresql://user:pass@host:5432/db?serverVersion=16&charset=utf8`       |

**Security Note**: Never commit production credentials. Use real environment variables or Symfony Secrets Vault.

## ğŸ“¦ Common Commands

### Symfony Console

```bash
# Database
php bin/console doctrine:database:create          # Create database
php bin/console doctrine:database:drop            # Drop database
php bin/console doctrine:migrations:migrate       # Run migrations
php bin/console make:migration                    # Create migration file
php bin/console doctrine:schema:update --force    # Update schema

# Cache
php bin/console cache:clear                       # Clear cache
php bin/console cache:warmup                      # Warm cache

# Assets
php bin/console importmap:install                 # Install import map
php bin/console assets:install                    # Install public assets

# Development
php bin/console make:controller HomeController    # Generate controller
php bin/console make:entity User                  # Generate entity
php bin/console make:form UserType               # Generate form type
php bin/console make:command app:import:data     # Generate command

# Debugging
php bin/console debug:routes                      # List all routes
php bin/console debug:config symfony              # Debug configuration
php bin/console debug:container --parameter       # List parameters

# Custom
php bin/console app:list:contacts                 # List all contacts
```

### Docker Command Examples

```bash
# Execute PHP commands in container
docker compose -p unisurf exec php php bin/console doctrine:migrations:migrate

# Open PHP container shell
docker compose -p unisurf exec php sh

# View logs
docker compose -p unisurf logs -f php

# Restart services
docker compose -p unisurf restart

# Stop all
docker compose -p unisurf down
```

## ğŸ— Build & Deployment

### Local Development Build

```bash
# Watch mode (recommended for development)
yarn watch

# One-time build (dev)
yarn dev

# Production build (optimized)
yarn build
```

### Code Quality & Testing

```bash
# Run all linters (CSS, TS, PHP, Twig)
./lint.sh

# Individual linters
yarn lint:css              # Check CSS/SCSS
yarn lint:css:fix          # Auto-fix CSS/SCSS
yarn tsc:check             # TypeScript type check
yarn lint:html             # Check Twig formatting
yarn lint:html:fix         # Auto-fix Twig

# PHP code formatting
./php-cs-fixer.sh          # Check and optionally fix PHP

# Run tests
./phpunit.sh               # PHPUnit tests
# or
./vendor/bin/phpunit tests

# Static analysis
php -d memory_limit=-1 ./vendor/bin/phpstan analyze src
```

### Production Deployment

```bash
# Using deploy script
./deploy.sh

# Skip migrations (if needed)
SKIP_MIGRATIONS=true ./deploy.sh

# Using Docker
docker compose -f docker-compose.yaml -f docker-compose.mariadb.yml up -d --build
```

### Pre-deployment Checklist

```bash
# 1. Run full pipeline (lint + test + build)
./pipeline.sh

# 2. Verify production build works
yarn build

# 3. Check database migrations
php bin/console doctrine:migrations:status

# 4. Review environment variables (.env.prod, secrets)
# 5. Commit changes to version control
# 6. Deploy with ./deploy.sh or Docker Compose
```

## ğŸ§ª Testing

### Run All Tests

```bash
./phpunit.sh
```

### Run Specific Test

```bash
./vendor/bin/phpunit tests/Controller/HomeControllerTest.php
```

### Watch Mode

```bash
./vendor/bin/phpunit tests --watch
```

### Coverage Report

```bash
./vendor/bin/phpunit tests --coverage-html var/coverage
```

## ğŸ³ Docker Commands

### Start Services

```bash
# Full dev stack
docker compose -f docker-compose.yaml -f docker-compose.dev.yaml -f docker-compose.mariadb.yml -f docker-compose.mariadb.dev.yml up -d --build

# Production-like (MariaDB only)
docker compose -f docker-compose.yaml -f docker-compose.mariadb.yml up -d --build
```

### Useful Docker Compose Commands

```bash
docker compose -p unisurf up -d              # Start (daemonized)
docker compose -p unisurf down               # Stop and remove
docker compose -p unisurf logs -f php        # Tail PHP container logs
docker compose -p unisurf exec php sh        # Open shell in PHP container
docker compose -p unisurf ps                 # List running containers
docker compose -p unisurf build --no-cache   # Rebuild images
```

## ğŸ—„ Database Management

### Switch Database Backend

1. Update `DATABASE_URL` in `.env` or `.env.local`
2. Stop containers and remove old volumes (if using Docker):
   ```bash
   docker compose -p unisurf down -v
   ```
3. Restart application:
   ```bash
   ./develop.sh  # or docker compose up
   ```
4. Recreate database and run migrations:
   ```bash
   php bin/console doctrine:database:create
   php bin/console doctrine:migrations:migrate
   ```

### Create & Run Migrations

```bash
# 1. After modifying Entity classes:
php bin/console make:migration

# 2. Review generated file in migrations/

# 3. Run migration:
php bin/console doctrine:migrations:migrate

# 4. Verify status:
php bin/console doctrine:migrations:status
```

### Backup Database

```bash
# MariaDB in Docker
docker compose -p unisurf exec mariadb mysqldump -u root -p unisurf > backup.sql

# SQLite
cp var/data_prod.db var/data_prod.db.backup
```

## ğŸ”„ CI/CD Pipeline

### GitHub Actions Workflows

**Triggers**: On push to `main` or `develop` branches, and on pull requests.

#### PHP Workflow (`.github/workflows/php.yml`)

Runs on PHP 8.3 and 8.4:

- âœ… Composer validation
- âœ… PHP-CS-Fixer (code formatting check)
- âœ… PHPStan (static analysis, level 4)
- âœ… Twig linting
- âœ… PHPUnit tests
- âœ… Asset build verification

#### Node Workflow (`.github/workflows/node.yml`)

Runs on Node 20.x and 22.x:

- âœ… TypeScript type checking
- âœ… CSS/SCSS linting
- âœ… Asset build verification
- âœ… Prettier formatting check

### Local CI Simulation

```bash
# Run full pipeline before pushing
./pipeline.sh
```

## ğŸ“ Development Workflow

### Adding a New Controller

```bash
php bin/console make:controller ContactController

# Edit src/Controller/ContactController.php
# Edit templates/contact/
# Update config/routes.yaml if needed
# Test locally: yarn watch + symfony server:start
```

### Adding a New Entity

```bash
php bin/console make:entity Contact

# Fill in properties interactively
# Review src/Entity/Contact.php
# Create migration:
php bin/console make:migration

# Review migrations/VersionXXXX.php
# Run migration:
php bin/console doctrine:migrations:migrate
```

### Adding a New Form

```bash
php bin/console make:form ContactType --entity=Contact
```

### Adding a New Service

Create `src/Service/MyService.php`:

```php
<?php
namespace App\Service;

class MyService
{
  // Your service logic
}
```

Services are auto-wired in controllers:

```php
public function __construct(private MyService $myService) {}
```

## ğŸ“š Documentation

Detailed documentation for specific topics:

- **Docker**: `docs/docker.md` â€” Setup, troubleshooting, container management
- **Symfony**: `docs/symfony.md` â€” Console commands, routes, configuration
- **Database**: `docs/database.md` â€” Migrations, backends, troubleshooting

## ğŸ†˜ Troubleshooting

### Port Already in Use

```bash
# Find process on port 8000
lsof -i :8000

# Kill process (macOS/Linux)
kill -9 <PID>
```

### Database Connection Errors

```bash
# Check DATABASE_URL
grep DATABASE_URL .env.local .env

# Test connection
php bin/console doctrine:database:create
php bin/console doctrine:database:drop

# If using Docker, check service status
docker compose -p unisurf ps mariadb
```

### Cache Issues

```bash
# Clear all cache
php bin/console cache:clear

# Warm up cache
php bin/console cache:warmup

# Remove cache directory
rm -rf var/cache/*
```

### Asset Compilation Errors

```bash
# Reinstall Node dependencies
rm -rf node_modules yarn.lock
yarn install

# Clear Webpack cache
rm -rf public/build

# Rebuild
yarn build
```

### Container Issues

```bash
# Rebuild containers
docker compose -p unisurf build --no-cache

# Remove volumes and restart
docker compose -p unisurf down -v
docker compose -p unisurf up -d --build
```

## ğŸ” Security

- **Never commit secrets**: Use `.env.local` and `.gitignore`
- **Use Symfony Secrets Vault** for production: `php bin/console secrets:set`
- **Validate user input**: Use Symfony Forms and Validator
- **CSRF protection**: Enabled by default in forms
- **SQL injection**: Use Doctrine ORM parameter binding
- **Update dependencies**: Run `composer update` and `yarn upgrade` regularly
- **Security advisories**: Check with `roave/security-advisories` (dev dependency)

## ğŸ“ Support & Contribution

For issues or questions:

1. Check `readme.md` and `docs/` folder
2. Check GitHub Issues
3. Create a detailed issue with error messages and steps to reproduce

## ğŸ“„ License

See `license` file for details.

---

**Last updated**: January 9, 2026
**Symfony Version**: 7.3
**PHP Minimum**: 8.3
